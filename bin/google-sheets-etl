#!/usr/bin/env php
<?php

declare(strict_types=1);

namespace fulldecent\GoogleSheetsEtl;

require_once __DIR__ . '/../vendor/autoload.php';
set_time_limit(300);
error_reporting(E_ALL);

const CREDENTIALS_FILE = __DIR__ . '/google-shared-team-dashboard-a38a4e97c700.json';

$databaseFile = __DIR__ . '/../local/example-data-mart.db';
$database = new \PDO('sqlite:' . $databaseFile, null, null, [
    \PDO::ATTR_PERSISTENT => false,
    \PDO::ATTR_ERRMODE => \PDO::ERRMODE_EXCEPTION
]);

## Banner ######################################################################
echo 'GOOGLE SHEETS ETL TOOL' . PHP_EOL;

$serviceAccountConfigurations = glob(__DIR__ . '/../local/*-*.json');
if (count($serviceAccountConfigurations) !== 1) {
    echo 'Production service account configuration not found. Skipping test.' . PHP_EOL;
    exit(0);
}

$tasks = new Tasks($serviceAccountConfigurations[0], $database);
$tasks->setConfiguration(__DIR__ . '/../local/config.json');

echo 'Service account: ' . $tasks->googleSheetsAgent->getAccountName() . PHP_EOL;
echo 'Database: ' . $databaseFile . PHP_EOL;

$tasks->loadSomeNewerSpreadsheets();